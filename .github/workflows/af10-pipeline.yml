name: AF10 DevOps Pipeline

on:
  push:
    branches:
      - AF10
  workflow_dispatch:
    inputs:
      log_errors:
        description: "Skapa loggfil om testerna misslyckas?"
        type: boolean
        default: false

jobs:

  tests:
    name: Run Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-mock

      - name: Run tests
        id: run_tests
        run: |
          pytest -q || echo "TEST FAILED" > error_log.txt

      - name: Upload error logs
        if: ${{ github.event.inputs.log_errors == 'true' && hashFiles('error_log.txt') != '' }}
        uses: actions/upload-artifact@v3
        with:
          name: test-error-log
          path: error_log.txt

  build:
    name: Build Docker Image
    needs: tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Build Docker Image
        run: |
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/crypto-app:latest .

  push_docker:
    name: Push Docker Image to Docker Hub
    needs: build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Login to DockerHub
        run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Push Image
        run: docker push ${{ secrets.DOCKERHUB_USERNAME }}/crypto-app:latest

  deploy:
    name: Deploy Docker Image to Azure
    needs: push_docker
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Azure WebApp
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ secrets.AZURE_WEBAPP_NAME }}
          publish-profile: ${{ secrets.AZURE_PUBLISH_PROFILE }}
          images: ${{ secrets.DOCKERHUB_USERNAME }}/crypto-app:latest
